## 데이터 관리 및 볼륨으로 작업하기

### 데이터 카테고리/다양한 종류의 데이터 이해하기

data?

### 실제 앱 분석하기

### 데모 앱 구축 & 이해하기

### 문제 이해하기

### 볼륨 소개

docker 에는 볼륨이라는 내장 기능이 존재함.
데이터를 유지하도록 도운다.

볼륨이란?
호스트머신의 폴더이다. 컨테이너나 이미지에 있는 것이 아닌 호스트 컴퓨터에 장착된 하드 드라이브에 존재하여 사용가능하거나.
컨테이너로 매핑되는 것을 의미함. 볼륨은 도커가 인식하는 호스트 머신인 컴퓨터에 있는 폴더로서 도커 컨테이너 내부의 폴더에 매핑됨.
COPY와 비슷하다? 하지만 COPY는 실제로 복사하도록 명령한 경로와 파일의 스냅샷을 취한 다음 이러한 파일과 폴더를 이미지에 복사하는게 전부이다
지속적인 관계나 연결이 없으며 이미지에 복사되는 일회성 스냅샷일 뿐임.
볼륨은 컨테이너 내부의 폴더를 호스트 머신상의 컨테이너 외부 폴더에 연결할 수 있다. 그리고 두 폴더의 변경사항은 다른 폴더에 반영된다.
호스트머신에 파일을 추가하면 컨테이너 내부에서 엑세스할 수 있고 컨테이너가 매핑된 경로에 파일을 추가하면 컨테이너 외부, 호스트머신에서
사용할 수 있다. 이 매커니즘으로 인해 볼륨을 통해 데이터를 유지할 수 있다. 볼륨은 컨테이너가 종료된 경우에도 지속되며 계속 존재한다.
컨테이너에 볼륨을 추가하는 경우 해당 볼륨은 제거되지 않으며 컨테이너가 제거되어도 해당 볼륨이 유지되므로 그 볼륨의 데이터가 유지된다.
컨테이너는 볼륨에 데이터를 읽고 쓸 수 있다.

### 첫 번째, 실패한 시도

### 명명된 볼륨으로 구조하기!

도커에는 실제로 여러가지의 외부 데이터 저장 매커니즘이 있다. 정확히는 두가지
볼륨, 바인드 마운트

볼륨

- 두가지타입의볼륨이 있다. 고유한 목적과 사용예가 각각 있음. 현재는 익명 볼륨을 사용했음.
- named 볼륨을 생성할 수 있다.
- 이름을 주지 않으면 도커가 자동으로 암호화된 이름을 지정한다.
- 익명 볼륨은 컨테이너가 존재하는 동안에만 실제로 존재한다.
- named 볼륨을 사용하면 컨테이너가 종료된 후에도 유지된다.

docker ~~~~ -v {volume 이름}:{데이터 경로}

### 익명 볼륨 제거하기

### 바인드 마운트 시작하기

소스코드에서 무엇이든 변경할 때 마다 이미지를 다시 빌드하지 않는한 이러한 변경사항은 컨테이너에 반영되지 않는다.
바인드마운트는 볼륨과 비슷하나 볼륨과 다르다 호스트머신의 파일 시스템상의 볼륨이 어디에 있는지 바인드 마운트는 알고 있다.
소스코드를 바인드마운트에 넣을 수 있으며 컨테이너는 이를 인식하여 실제로 스ㅂ냅ㅂ샷에서 복사하는것이아니라바인디ㅇ마운트애
영구적이고 편집가능한 데이터에 접근ㅇ

docker run ~~~ -v {매핑할 호스트 절대경로}:{컨테이너 내부경로}

### 바인드 마운트 바로가기

바인드마운트 적용시 express를 찾을 수 없다는 경고가 발생하고 프로세스가 진행되지 않는다.
전체폴더를 app 폴더에 바운딩 할 때에 문제가 생김 컨테이너 내부의 app 폴더를 로컬 폴더로 덮어쓴ㄴ것이 끄ㅡㅌ은 아니다.
처음에 이미지가 생성될 대 모든것을 app 폴더에 복사한다. 모든 종속성을 설치하지만 결국 이 모든 단계가 무의미하게 되는것
이 때 로컬폴더에는 node_module이 존재하지않아 문제가 생김. 해당 폴더는 컨테이너에만 존재했음.
컨테이너와 볼륨 및 바인드마운트를 가지고 있다면 -v 로 컨테이너에 둘다 마운트 할 수 있다. 즉 컨테이너의 내부의 어떤 폴더가 호스트 머신의 폴더에 마운트되거나 연결된다.
도커에게 외부에서 덮어쓰지 않아야 하는 부분이 있다는 걸 알려야 한다. 또 다른 볼륨으로 해결할 수 있다.(익명 볼륨)
볼륨을 하나 더 추가하여 /app/node_modules 폴더를 추가한다.

### 다른 볼륨 결합 & 병합하기

### Nodejs 특화 조정: 컨테이너에서 Nodemon 사용하기

server.js의 코드는 노드 런타임에 의해 노드에 의해 실행된다.
해당 런타임으로 우리의 파일이 실행됨.

### 볼륨 & 바인딩 마운트 요약

docker run을 사용할때 -v 옵션을 사용하는 기본적인 세 가지 방식이 있다.

docker run -v /app/data ... 익명 볼륨 생성
docker run -v data:/app/data ... named 볼륨 생성
docker run -v /path/to/code:/app/code ... 바인드 마운트

익명볼륨

- 컨테이너에 연결된 일종의 볼륨을 생성한다. 컨테이너가 제거되면 같이 제거된다.
- 컨테이너간에 데이터를 공유할 수 없다.
- 컨테이너에 이미 존재하는 특정 데이터를 잠그는데 유용하다. 해당 데이터가 다른 모듈에 의해 덮어쓰여지는 것을 방지함.
- 시간을 절약할 수 있다.
- 호스트머신에 폴더를 생성한다. 컨테이너가 제거되면 폴더도 제거된다.

named 볼륨

- Dockerfile에서 생성할 수 없다. 컨테이너 생성시 -v 옵션으로 생성한다.
- 콜론앞에 이름을 붙인다.
- 특정 컨테이너에 연결되지 않는다.
- 컨테이너를 제거해도 살아 남는다. 제거를 하기 위해선 따로 cli 명령어를 통해 제거해야한다.
- 컨테이너간에 데이터를 공유할 수 있다. 다수의 다양한 컨테이너에 동일한 볼륨을 마운트 할 수 있다.

바인드 마운트

- 하나의 컨테이너에 국한되지 않는다 다수의 컨테이너에 연결가능
- 컨테이너 종료 및 제거 후에도 유지된다.
- 바인드 마운트의 데이터를 지우려면 실제 호스트머신에서 삭제해야 한다.
- 컨테이너간에 공유가능.

### 읽기 전용 볼륨 살펴보기

:ro read only 도커가 그폴더나 하위폴더에 읽기만 가능하게됨.

### Docker 볼륨 관리하기

### COPY 사용 vs 바인드 마운트 사용

npm i 이후에 실행하는 copy 명령어를 지워도된다.
단 docker run 명령은 개발중에 사용하는 명령이다. 개발중에 바인드 마운트를 사용하여 코드의 변경사항을 실행중인 컨테이너에 즉시 반영한다.
개발을 마친 뒤에는 실제로 해당 컨테이너를 서버에 가져와 넣는다 서버에서 바인드 마운트로 실행하는것을 원하지 않을것.
데이터가 유지되도록 다른 볼륨을 사용할수는 있지만 바인드 마운트가 사용되길 원하진 않는다. 컨테이너가 서버상의 제품상태로 실행 중이라면
실행되는 동안 실시간으로 업데이트되는 연결된 소스가 없기 때문 운영 환경에서는 항상 코드의 스냅샷을 가지고있길 원한다.

### 모든것을 복사하진 마세요 dockerignore 파일 사용하기

### 환경 변수 & .env 파일 작업

도커는 빌드타임 인수와 런타임 환경변수를 지원한다.

인수

- dockerfile에서 특정 dockerfile 명령으로 다른값을 추출하는데 사용할 수 있는 유연한ㄷㅔ이트비트 즉 변수를 지정할수 있다.
- docker build 시 --build-arg 옵션과 함께 제공되는 인수를 기반으로 한다
- 실행중인 애플리케이션의 전체 코드에서 사용할 수 있다.

환경변수

- dockerfile 내부에서 사용가능하다.
- dockerfile의 ENV 옵션으로 설정하여 docker run 에서 --env로 구체적인 값을 제공한다.

둘을 사용하면 보다 유연한 이미지와 컨테이너를 만들 수 있다.

Image

- ENV {변수명}={변수값}

Container

- docker run -e {변수명}={변수값}

.env

- docker run --env-file ./.env

### 환경 변수 & 보안

보안 데이터를 dockerfile에 포함시키지마라.
런타임에만 사용되는 별도의 환경변수 파일로 이동시켜라

- docker run

그렇지 않으면 이미지에 포함 되며 모든 이가 docker history 를 통해 이 값을 읽을 수 있다.

### 빌드 인수 사용하기

### 요약

컨테이너는 읽고 쓸수 있다.
볼륨은 특히 컨테이너 제거 후에도 살아남아야 데이터와 함께 데이터를 저장하는데 도움이 된다.
바인드 마운트는 직접적인 컨테이너의 상호 작용에 도움이 된다 소스코드를 업데이트 할 수 있으며 최신 소스코드를 컨테이너 내부에서 사용가능하다

컨테이너는 도커의 핵심이며 데이터를 읽고 쓸 수 있다.
컨테이너는 이미지 위에 이 read-write 레이어를 추가한다.
컨테이너가 제거되면 컨테이너 내부의 데이터는 제거된다.

볼륨은 컨테이너가 실행되는 호스트 머신상의 폴더이다.
도커에 의해 관리되며 도커 컨테이너에 마운트된다.
컨테이너 내부에 매핑된 경로와 호스트 머신에 자동적으로 생성된 폴더 사이에 이러한 연결이 존재한다.
컨테이너 내부의 매핑된 경로에 저장된 모든 내용은 호스트머신에 저장된다.

named 볼륨은 컨테이너가 제거되어도 살아남기 때문에 유용하다. 데이터를 영구적으로 저장하는 경우에 필요하다
익명 볼륨은 컨테이너에 연결되며 컨테이너가 제거되면 함께 제거된다. 영구데이터를 저장하는데에 유용하지 않다
컨테이너를 좀더 효율적으로 만들도록 임시데이터를 저장하는데에는 유용하다
